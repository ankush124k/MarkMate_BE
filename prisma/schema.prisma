// This is your Prisma schema file.

// 1. Tells Prisma how to connect to your database.
// It reads the connection string from your .env file.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Tells Prisma to generate the JavaScript client.
generator client {
  provider = "prisma-client-js"
}

// ----------------------------------------------
// DATABASE MODELS
// ----------------------------------------------

model Agency {
  id                  String                 @id @default(cuid())
  name                String
  subdomain           String                 @unique // For agency-a.markmate.com
  status              String                 @default("active") // active, trial, cancelled
  createdAt           DateTime               @default(now())
  users               User[]
  batches             UploadBatch[]
  assessorCredentials AssessorCredential[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // The hashed password for logging into MarkMate
  role      String   @default("AGENCY_MEMBER") // SUPERADMIN, AGENCY_ADMIN, AGENCY_MEMBER
  createdAt DateTime @default(now())
  agency    Agency?  @relation(fields: [agencyId], references: [id])
  agencyId  String? // '?' means this can be NULL (for superadmins)
}

model AssessorCredential {
  id        String   @id @default(cuid())
  username  String
  password  String // ENCRYPTED Skill India Portal password
  createdAt DateTime @default(now())
  agency    Agency   @relation(fields: [agencyId], references: [id])
  agencyId  String

  // --- Relationships ---
  // One credential can be used for many batches
  uploadBatches UploadBatch[] // <-- NEW
}

// Model for a single Excel file upload
model UploadBatch {
  id                   String                 @id @default(cuid())
  fileName             String
  portalBatchId        String
  status               String                 @default("pending") // pending, processing, complete, failed
  errorMessage         String?                // <-- NEW: To store batch-level errors (e.g., "Login failed")
  createdAt            DateTime               @default(now())
  startedAt            DateTime?
  completedAt          DateTime?
  
  // This new field will store the dynamic headers from the Excel
  // file, like ["Candidate_ID", "Candidate_Name", "NOS1_Theory", "NOS1_Practical", "NOS2_Theory", ...]
  excelHeaders         Json?                  

  // --- Relationships ---
  agency               Agency                 @relation(fields: [agencyId], references: [id])
  agencyId             String
  assessorCredential   AssessorCredential?    @relation(fields: [assessorCredentialId], references: [id])
  assessorCredentialId String?
  
  // This relationship is still the same
  candidates           Candidate[]

  @@index([portalBatchId])
}

// Model for a single row in the Excel file
// ALL 'nos' columns have been DELETED from this model.
model Candidate {
  id            String    @id @default(cuid())
  candidateId   String // e.g., "CAN_2963617"
  candidateName String? // e.g., "Rajesh Kumar"
  status        String    @default("pending") // pending, success, failed
  errorMessage  String?
  excelRowIndex Int       // We'll use this to remember the original row number

  // --- Relationships ---
  batch    UploadBatch @relation(fields: [batchId], references: [id])
  batchId  String

  // One Candidate can now have MANY marks
  marks    CandidateMark[] 

  @@index([batchId])
}

// --- NEW TABLE ---
// Stores the marks for a single NOS for a single candidate
model CandidateMark {
  id              String   @id @default(cuid())
  nosIdentifier   String // e.g., "NOS1" or "NOS2"
  theoryMarks     Int?
  practicalMarks  Int?

  // --- Relationships ---
  // Each mark belongs to one candidate
  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  @@index([candidateId])
}