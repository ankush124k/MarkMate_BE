// This is your Prisma schema file.

// 1. Tells Prisma how to connect to your database.
// It reads the connection string from your .env file.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Tells Prisma to generate the JavaScript client.
generator client {
  provider = "prisma-client-js"
}

// ----------------------------------------------
// DATABASE MODELS
// ----------------------------------------------

model Agency {
  id                  String                 @id @default(cuid())
  name                String
  subdomain           String                 @unique // For agency-a.markmate.com
  status              String                 @default("active") // active, trial, cancelled
  createdAt           DateTime               @default(now())
  users               User[]
  batches             UploadBatch[]
  assessorCredentials AssessorCredential[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // The hashed password for logging into MarkMate
  role      String   @default("AGENCY_MEMBER") // SUPERADMIN, AGENCY_ADMIN, AGENCY_MEMBER
  createdAt DateTime @default(now())
  agency    Agency?  @relation(fields: [agencyId], references: [id])
  agencyId  String? // '?' means this can be NULL (for superadmins)
}

model AssessorCredential {
  id        String   @id @default(cuid())
  username  String
  password  String // ENCRYPTED Skill India Portal password
  createdAt DateTime @default(now())
  agency    Agency   @relation(fields: [agencyId], references: [id])
  agencyId  String

  // --- Relationships ---
  // One credential can be used for many batches
  uploadBatches UploadBatch[] // <-- NEW
}

// Model for a single Excel file upload
model UploadBatch {
  id            String    @id @default(cuid())
  fileName      String
  portalBatchId String // <-- NEW: The ID from the Skill India Portal (e.g., "42856")
  status        String    @default("pending") // pending, processing, complete, failed
  createdAt     DateTime  @default(now())
  startedAt     DateTime? // <-- NEW: Set when the worker starts the job
  completedAt   DateTime? // <-- NEW: Set when the worker finishes or fails

  // --- Relationships ---
  agency    Agency   @relation(fields: [agencyId], references: [id])
  agencyId  String
  
  // Link to the credential that was used for this job
  assessorCredential   AssessorCredential? @relation(fields: [assessorCredentialId], references: [id]) // <-- NEW
  assessorCredentialId String? // <-- NEW: The credential selected by the user

  candidates Candidate[]
  
  @@index([portalBatchId]) // <-- NEW: Add index for searching
}

// Model for a single row in the Excel file
model Candidate {
  id           String   @id @default(cuid())
  candidateId  String // e.g., "CAN_2963617"
  candidateName String? // <-- NEW: "Rajesh Kumar"
  status       String   @default("pending") // pending, success, failed
  errorMessage String? // Stores the error if it fails
  
  // --- All the data from the Excel file ---
  nos1_theory_marks    Int?
  nos1_practical_marks Int?
  nos2_theory_marks    Int?
  nos2_practical_marks Int?
  // ...etc

  batch    UploadBatch @relation(fields: [batchId], references: [id])
  batchId  String

  @@index([batchId])
}